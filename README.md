# Debian 10 - Installation d‚Äôune seebox anonyme et s√©curis√©e avec Deluge, Jackett, Sonarr, Radarr, Lidarr, Docker, Traefik et Jellyfin

Date: 22/05/2022
Date Created: 22 mai 2022 15:01
Priorit√©: Important üî•
Statut: En cours

<aside>
‚òù Je vais vous parlez ici de la proc√©dure pour installer une seedbox automatis√©e, anonyme et s√©curis√©e sur Debian 10 avec l‚Äôutilisation de Docker et OpenVPN.

</aside>

# Les outils

> A quoi sert ce tutoriel et cette liste d‚Äôoutils ?
>

> Ces derniers permet d‚Äôautomatiser le t√©l√©chargement des films, s√©ries TV et albums de musique d√®s leur disponibilit√© pour ensuite les streamer sur votre ordinateur, smartphone ou encore votre smartTV, alors cet article est fait pour vous ! C√¥t√© s√©curit√©, vous serez totalement anonyme et prot√©g√© !
>

### Docker

Votre seedbox sera d√©ploy√©e en quelques minutes ! Docker permet en quelques commandes d‚Äôinstaller et d‚Äôex√©cuter tous les outils dont vous aurez besoin. Chaque outil est isol√© et poss√®de son propre container Docker. Chaque container contient toutes les d√©pendances (librairies, d√©mons, configurations, etc.) n√©cessaires √† son ex√©cution sans interf√©rer avec les autres outils ou d‚Äôautres services install√©s sur votre serveur. Enfin les mises √† jour des outils sont simplifi√©es et peuvent √™tre totalement automatis√©es. Les images Docker sont versionn√©es et permettent de red√©ployer une version pr√©c√©dente tr√®s facilement.

### Deluge

Cette outils vas vous permettre de t√©l√©charger des films, s√©ries TV et fichiers audio directement depuis des fichiers .torrent. **Deluge** est donc un client BitTorrent multiplateforme libre bas√© sur libtorrent. Il est r√©put√© pour sa stabilit√©, sa vitesse et son c√¥t√© poids plume et dispose d‚Äôune interface claire et intuitive. Enfin il s‚Äôav√®re extr√™mement modulable gr√¢ce √† la possibilit√© de lui ajouter de nombreux plugins.

![Untitled](/home/florianspk/Personel/ServeurDocker/media/img-readme/Untitled.png)

### Jackett

Cette outil permet de combler ce manque et prend en charge plus d‚Äôune centaine de trackers. De nombreux trackers Fran√ßais (YGGtorrent) sont support√©s ainsi que des trackers priv√©s et semi-priv√©s n√©cessitant un compte. **Jackett** fonctionne comme un serveur proxy, lorsque vous effectuez une recherche via Sonarr ou Radarr, celui-ci transforme et transmet la requ√™te au tracker, analyse la r√©ponse puis renvoie les r√©sultats √† l‚Äôapplication √©mettrice. Jackett prend aussi en charge les flux RSS.

![Untitled](/home/florianspk/Personel/ServeurDocker/media/img-readme/Untitled 1.png)

### Sonarr

Ce dernier permet de rechercher vos fichiers *.torrent* et d‚Äôautomatiser le t√©l√©chargement de vos s√©ries pr√©f√©r√©es. Vous ajoutez une s√©rie dans l‚Äôinterface en pr√©cisant la qualit√© et la langue souhait√©es et Sonarr recherchera celle-ci via les indexers configur√©s. Enfin Sonarr ajoutera automatiquement dans Deluge la s√©rie en t√©l√©chargement. Parmi les nombreuses fonctionnalit√©s de Sonarr, celui-ci dispose de t√¢ches automatiques et quotidiennes ajoutant automatiquement un √©pisode fraichement sorti. L‚Äôinterface dispose aussi d‚Äôun calendrier r√©pertoriant les sorties des prochains √©pisodes.

![https://howto.wared.fr/wp-content/uploads/2020/04/sonarr_screenshot.png](https://howto.wared.fr/wp-content/uploads/2020/04/sonarr_screenshot.png)

**Radarr** et **Lidarr** ont un fonctionnement similaire √† Sonarr mais respectivement pour les films et les fichiers audio.

### Treafik

Traefik est un routeur Edge open-source qui fait de la publication de vos services une exp√©rience amusante et facile. Il re√ßoit les demandes au nom de votre syst√®me et trouve les composants qui sont responsables de leur traitement.

![Untitled](/home/florianspk/Personel/ServeurDocker/media/img-readme/Untitled 2.png)

### Jellyfin

Ce dernier est un serveurmultimedia. Il s'agit d'un fork de Emby (anciennement Media Browser)
devenu officiellement propri√©taire en 2018. Il permet de mettre sa m√©diath√®que √† disposition sur le web, qu'il s'agisse de contenu vid√©o (films et s√©ries, t√©l√©vision), audio, ou d'images.

![Untitled](/home/florianspk/Personel/ServeurDocker/media/img-readme/Untitled 3.png)

<aside>
‚òù Nous allons donc mettre tous ces outils en place pour avoir notre propre serveur de film, s√©rie et musique

</aside>

---

# Pr√©requis

- Votre utilisateur doit avoir acc√®s √† *sudo*.
- Les paquets *`curl`* et *`software-properties-common*` doivent √™tre install√©s sur votre syst√®me. Dans le doute, tapez la commande suivante :

```bash
sudo apt-get install -y curl software-properties-common
```

- Vos d√©p√¥ts APT doivent √™tre √† jour. Dans le doute, tapez la commande suivante :

```bash
sudo apt-get update
```

---

# I**nstallation de Docker & Docker Compose**

Installez *Docker* :

```bash
sudo apt-get install -y docker.io
```

- V√©rifiez que *Docker* est correctement install√© avec la commande :

```bash
‚ùØ docker -v
Docker version 20.10.16, build aa7e414
```

La commande doit retourner la version install√©e de *Docker*.

T√©l√©chargez *Docker Compose* avec la commande suivante en modifiant la version si besoin avec la derni√®re release du **[repository officiel de Docker](https://github.com/docker/compose/releases/latest)** :

```bash
sudo curl -L https://github.com/docker/compose/releases/download/1.27.4/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose
```

Ajoutez les droits d'ex√©cution sur le binaire de Docker Compose :

```bash
sudo chmod +x /usr/local/bin/docker-compose
```

V√©rifiez l'installation de *Docker Compose* avec la commande :

```bash
docker-compose -v
docker-compose version 1.27.4, build 8a1c60f6
```

Si l'installation s'est correctement effectu√©e, cette commande doit vous renvoyer la version de

*Docker Compose*

# La mise en place de traefik

Traefik est un reverse-proxy et un load-balancer moderne con√ßu (par un Fran√ßais) pour faciliter le d√©ploiement des microservices (Docker, Kubernetes, AWS, etc.). Traefik est extr√™mement simple √† configurer et g√®re automatiquement vos certificats d√©livr√©s par Let‚Äôs Encrypt. De plus, il est capable de charger vos containers dynamiquement sans interruption de service et dispose d‚Äôun dashboard affichant l‚Äôensemble de vos routes configur√©es.

> Un reverse proxy est le r√©cepteur frontal de toutes les requ√™tes HTTP venant de l‚Äôext√©rieur. Celui-ci les redirigera vers les bonnes instances des conteneurs Docker. Dans notre cas, nous disposons d‚Äôune multitude de containers Docker et nous ne pouvons pas toutes les faire √©couter sur le port 80 ou 443, d‚Äôo√π l‚Äôutilisation d‚Äôun reverse proxy. Ajoutez √† cela un joli nom de domaine √† votre seedbox en s√©curisant le tout avec le protocole SSL/TLS et un certificat Let‚Äôs Encrypt.
>

![https://howto.wared.fr/wp-content/uploads/2020/05/traefik_docker.png](https://howto.wared.fr/wp-content/uploads/2020/05/traefik_docker.png)

### Cr√©ation de l‚Äôutilisateur *traefik*

Si vous avez plusieurs *docker-compose.yml* ou si vous avez pour projet d‚Äôen cr√©er par la suite, il est pr√©f√©rable d‚Äôisoler et de d√©dier un *docker-compose.yml* √† Traefik. Il est recommand√© de ne pas le lancer sous votre super-utilisateur et de cr√©er un utilisateur d√©di√©.

- Ajoutez l‚Äôutilisateur traefik :

```bash
sudo adduser traefik
```

- Ajoutez-le au groupe *docker* :

```bash
sudo adduser traefik docker
```

- Attribuer le dossier treafik a l‚Äôutilisateur traefik  :

```bash
sudo chown -r treafik:traefik /home/traefik
```

### Le r√©seau Traefik

Dans la premi√®re partie de ce tutoriel, chaque container Docker partage le r√©seau de votre machine pour √™tre accessible en local avec la propri√©t√© `network_mode: "host"`. Avec un reverse proxy, cette configuration n‚Äôa plus lieu d‚Äô√™tre et nous allons en profiter pour ajouter un peu plus de s√©curit√© en isolant vos containers dans un r√©seau uniquement accessible par Traefik et vos  containers.

Connectez-vous sous l‚Äôutilisateur *traefik* :

```bash
su traefik
```

- D√©placez-vous dans le r√©pertoire personnel de cet utilisateur :

```bash
cd
```

- Cr√©ez le r√©seau d√©di√© √† Traefik et √† l‚Äôensemble de vos containers :

```bash
docker network create traefik_network
```

### Explication de L‚Äôimage Traefik

```yaml
version: '3.7'
services:
  traefik:
    image: "traefik:v2.2"
    container_name: "traefik"
    restart: unless-stopped
    networks:
      - traefik_network
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /home/traefik/traefik.toml:/traefik.toml:ro
      - /home/traefik/traefik_dynamic.toml:/traefik_dynamic.toml
      - /home/traefik/acme.json:/acme.json
      - /home/traefik/log/access.log:/var/log/access.log

networks:
  traefik_network:
    external: true
```

- **/var/run/docker.sock:/var/run/docker.sock:ro** : pr√©cise le socket Unix de votre docker. Laissez cette valeur par d√©faut.
- **/home/traefik/traefik.toml:/traefik.toml:ro** : pr√©cise le chemin du fichier de configuration de Traefik. Nous le cr√©erons √† l‚Äô√©tape suivante.
- **/home/traefik/acme.json:/acme.json** : pr√©cise le chemin du fichier contenant les informations relatives √† vos certificats.
- **traefik_network** : ici nous sp√©cifions le r√©seau cr√©√©
  pr√©c√©demment et d√©di√© √† Traefik. Nous ajouterons les diff√©rents
  containers dans ce r√©seau par la suite.

### Configuration Traefik

Traefik peut √™tre configur√© de diff√©rentes mani√®res, nous allons
d√©tailler ici, la configuration recommand√©e par Traefik, √† savoir par un
fichier statique au format TOML.

1. Traefik stocke les informations li√©es au certificat dans un fichier **acme.json**. Vous devez au pr√©alable lui attribuer un minimum de permissions :

```bash
chmod 600 /home/traefik/acme.json
```

- Cr√©ez le fichier de configuration Traefik ***/home/traefik/traefik.toml*** en ajoutant les lignes suivantes. L‚Äôunique propri√©t√© √† modifier est l‚Äô**email** :

    ```
    debug = true
    logLevel = "DEBUG"
    
    [providers]
        [providers.file]
            # Dynamic files
            filename = "traefik_dynamic.toml"
            watch = true
        [providers.docker]
            endpoint = "unix:///var/run/docker.sock"
            exposedByDefault = false
            watch = true
    
    [entryPoints]
        [entryPoints.web]
            address = ":80"
    
        [entryPoints.web.http]
            [entryPoints.web.http.redirections]
                [entryPoints.web.http.redirections.entryPoint]
                    to = "websecure"
                    scheme = "https"
    
        [entryPoints.websecure]
            address = ":443"
    
    [certificatesResolvers.leresolver.acme]
      email = "email@gmail.com"
      storage = "acme.json"
      [certificatesResolvers.leresolver.acme.httpChallenge]
        entryPoint = "web"
    
    [api]
      dashboard = true
    
    [global]
      sendAnonymousUsage = false
      checkNewVersion = false
    
    [accessLog]
      filePath = "/var/log/access.log"
      format = "json"
    ```


**[providers.docker]** : cette directive permet tout simplement d‚Äôactiver le support Docker.
**endpoint = ¬´¬†unix:///var/run/docker.sock¬†¬ª** : pr√©cise le socket Unix de votre Docker √† Traefik. Laissez la valeur par d√©faut.

**watch = true** : permet de d√©ployer √† chaud les containers d√®s qu‚Äôun changement dans la configuration est d√©tect√©e.

**exposedByDefault = false** : n‚Äôexpose pas par d√©faut les containers au monde ext√©rieur. Il est pr√©f√©rable d‚Äôactiver cette option dans le *docker-compose.yml* pour chacun des containers dans le cas o√π, si pour une raison ou une autre, vous ne souhaiteriez plus rendre accessible un container de l‚Äôext√©rieur.

**[entryPoints.web]** et **[entryPoints.websecure]** : ces directives d√©finissent les points d‚Äôentr√©e de votre Traefik. **web** et **websecure** sont purement indicatifs, vous pouvez les nommer autrement mais ils doivent correspondre aux labels que nous d√©finirons plus tard dans le *docker-compose.yml*. Les propri√©t√©s **adress** pr√©cisent les ports sur lesquels Traefik ¬´ √©coute ¬ª en fonction du point d‚Äôentr√©e.

**[entryPoints.web.http.redirections.entryPoint]** : force la redirection du port 80 vers le port 443 donc force le HTTP en HTTPS.

**[certificatesResolvers.[*NOM_RESOLVEUR*].acme]** : nous indiquons ici que nous souhaitons utiliser le protocole ACME (donc le service Let‚Äôs Encrypt) pour obtenir un certificat. Le nom du
r√©solveur est purement indicatif, il doit simplement correspondre aux labels que nous d√©finirons plus tard dans le *docker-compose.yml*.
**storage = ¬´¬†acme.json¬†¬ª** : la propri√©t√© **storage** pr√©cise √† Traefik le fichier (que nous avons cr√©√© pr√©c√©demment) o√π seront stock√©es les informations relatives aux certificats. L‚Äôerreur commune est d‚Äôindiquer le chemin absolu (dans notre cas */home/traefik/acme.json*), ici le chemin √† renseigner est celui au sein du container Traefik, il faut donc laisser cette valeur par d√©faut.

**[certificatesResolvers.[*NOM_RESOLVEUR*].acme.httpChallenge]** : cette directive pr√©cise tout simplement par quel point d‚Äôentr√©e (dans notre cas le port 80) Traefik peut obtenir un certificat.

- D√©placez-vous dans le r√©pertoire personnel de l‚Äôutilisateur *traefik* et d√©marrez le container :

```bash
cd
docker-compose up -d
```

<aside>
‚úÖ Traefik devrait se lancer sans aucun probleme

</aside>

# Droits Unix et arborescence

Nous allons maintenant nous occuper des outils multimedia.

Il est recommand√©, pour des raisons de s√©curit√©, de cr√©er un  utilisateur d√©di√© √† la gestion des volumes Docker (Deluge, Jackett, Sonarr, Radarr et Lidarr) et de ne pas les lancer sous votre
super-utilisateur.

1. Cr√©ez un utilisateur ***media*** :

```bash
sudo adduser media
```

- Ajoutez-le au groupe *docker* :

```bash
sudo adduser media docker
```

L‚Äôarborescence utilis√©e sur le filesystem sera la suivante :

```
data
‚îú‚îÄ‚îÄ movies
‚îú‚îÄ‚îÄ music
‚îú‚îÄ‚îÄ torrents
‚îî‚îÄ‚îÄ tv
```

Le choix de sp√©cifier un r√©pertoire par type de m√©dia sera tr√®s utile pour la gestion des librairies au sein de Jellyfin.

Un fichier t√©l√©charg√© via Deluge restera dans le dossier ***/data/torrents*** tant qu‚Äôil sera en cours de t√©l√©chargement. Une fois termin√©, celui-ci  sera automatiquement d√©plac√© par Deluge dans le r√©pertoire ***/data/movies***, ***/data/tv*** ou ***/data/music*** selon si le t√©l√©chargement a √©t√© ajout√© par Radarr, Sonarr ou Lidarr.
Nous verrons plus tard comment configurer automatiquement le d√©placement d‚Äôun m√©dia dans le bon r√©pertoire.

1. Cr√©ez l‚Äôarboresence d√©di√©e aux t√©l√©chargements :

```bash
sudo mkdir -p /data/torrents /data/movies /data/music /data/tv
```

- Attribuez ces r√©pertoires √† l‚Äôutilisateur ***media*** pour √©viter de futurs probl√®mes de permissions :

    ```bash
    sudo chown media:media /data/torrents /data/movies /data/music /data/tv
    ```


# Configuration avec OpenVPN

Connectez-vous sous l‚Äôutilisateur *media* :

```bash
su media
```

D√©placez-vous dans le r√©pertoire personnel de cet utilisateur :

```bash
cd
```

Cr√©ez le fichier ***/home/media/.env***¬†et modifiez les valeurs en fonction de votre configuration :

```bash
PUID=1001
PGID=1001
PATH_MEDIA= /PATH/TO/MEDIA
VPN_USER= piauser
VPN_PASS= piapwd
NETWORK= treefik_network
BASE_HOST= dns.fr
LAN_NETWORK=192.168.1.0
```

- **PUID** et **GUID** : ces deux variables repr√©sentent respectivement l‚Äôidentifiant et le groupe de votre utilisateur *media*. Ces valeurs peuvent √™tre diff√©rentes d‚Äôun syst√®me √† l‚Äôautre. Tapez la commande suivante pour obtenir le PUID et GUID de votre utilisateur *media* :

```
id media
uid=1001(media) gid=1001(media) groups=1001(media),999(docker)
```

- Dans cet exemple, le ***uid*** correspond au **PUID** et le ***gid*** correspond au **PGID**.
- **PATH_MEDIA** : chemin absolu du **dossier parent** des dossiers */data/torrents*, */data/movies*, */data/music* et */data/tv* o√π seront stock√©s vos m√©dias. **Si vous choisissez un chemin autre que celui-ci, assurez-vous¬†que l‚Äôutilisateur *media* ait les droits de lecture et d‚Äô√©criture dans le r√©pertoire sp√©cifi√©.**
- **VPN_USER=*pia_user*** et **VPN_PASS=*pia_password*** : utilisateur et mot de passe de votre compte PIA.
- **LAN_NETWORK** : adresse IP (notation CIDR) de votre r√©seau local.

  Si vous √™tes sur un kimsufi, serveur d√©di√© ou VPS, cette valeur n‚Äôa pas d‚Äôimportance. Laissez la valeur par d√©faut 192.168.1.0.

  Si vous r√©alisez l‚Äôinstallation sur votre syst√®me ou un syst√®me de
  votre r√©seau local, cette valeur doit √™tre¬†correctement renseign√©e.
  Tapez la commande¬†`ifconfig` et identifiez votre r√©seau local (***eth0*** le plus souvent) :


```
ifconfig
eth0: flags=4163 ¬†mtu 1500

¬† ¬† ¬† ¬† inet 192.168.1.10 ¬†netmask 255.255.255.0 ¬†broadcast 192.168.1.255
¬† ¬† ¬† ¬† ether 68:05:ca:0b:fe:25 ¬†txqueuelen 0 ¬†(Ethernet)
¬† ¬† ¬† ¬† RX packets 28203743 ¬†bytes 36171326044 (33.6 GiB)
¬† ¬† ¬† ¬† RX errors 0 ¬†dropped 19925 ¬†overruns 0 ¬†frame 0
¬† ¬† ¬† ¬† TX packets 26710466 ¬†bytes 165269242671 (153.9 GiB)

¬† ¬† ¬† ¬† TX errors 0 ¬†dropped 0 overruns 0 ¬†carrier 0 ¬†collisions 0
```

T√©l√©chargez l‚Äôimage Deluge et d√©marrez-la une premi√®re fois pour
forcer la cr√©ation du r√©pertoire d√©di√© aux fichiers de configuration
avec la commande suivante :

```bash
docker-compose up -d deluge
```

Arr√™tez le container *deluge* :

```bash
docker-compose stop deluge
```

- T√©l√©chargez les certificats et fichiers de configuration de PIA √† l‚Äôadresse suivante : [https://www.privateinternetaccess.com/openvpn/openvpn.zip](https://www.privateinternetaccess.com/openvpn/openvpn.zip).
- D√©compressez l‚Äôarchive et copiez les certificats ***crl.rsa.2048.pem***, ***ca.rsa.2048.crt*** et le fichier de configuration OpenVPN ***.ovpn*** de votre choix dans le r√©pertoire ***/home/media/deluge/config/openvpn***.**V√©rifiez bien que vous ayez uniquement ces 3 fichiers dans le r√©pertoire. Un seul fichier de configuration OpenVPN *.ovpn* doit √™tre pr√©sent.**
- Ces fichiers doivent appartenir √† l‚Äôutilisateur et au groupe *media* et doivent avoir les permissions 755.¬†Revenez sous votre super utilisateur et modifiez le propri√©taire et les permissions du fichier¬†*.ovpn*¬†:

```bash
exit
```

```bash
sudo chown media:media /home/media/deluge/config/openvpn/*
sudo chmod 755 /home/media/deluge/config/openvpn/*
```

Connectez-vous √† nouveau sous l‚Äôutilisateur *media* et d√©placez-vous dans le r√©pertoire personnel de cet utilisateur :

```bash
su media
```

```bash
cd
```

D√©marrez les containers *deluge* :

```bash
docker-compose up -d
```
